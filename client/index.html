<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat WebSocket</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
      .container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 600px;
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }
      .header h1 {
        font-size: 24px;
        margin-bottom: 8px;
      }
      .status {
        font-size: 14px;
        opacity: 0.9;
      }
      .status.connected {
        color: #10b981;
      }
      .status.disconnected {
        color: #ef4444;
      }
      .status.connecting {
        color: #f59e0b;
      }

      .login-form {
        padding: 30px;
      }
      .login-form input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        font-size: 16px;
        margin-bottom: 12px;
      }
      .login-form input:focus {
        outline: none;
        border-color: #667eea;
      }
      .login-form button {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .login-form button:hover {
        transform: translateY(-2px);
      }
      .login-form button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .chat-container {
        display: none;
        flex-direction: column;
        height: 600px;
      }
      .chat-container.active {
        display: flex;
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f9fafb;
      }
      .message {
        margin-bottom: 16px;
        animation: slideIn 0.3s ease;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .message.system {
        text-align: center;
        color: #6b7280;
        font-size: 14px;
        font-style: italic;
      }
      .message.user .username {
        font-weight: 600;
        color: #667eea;
        margin-bottom: 4px;
      }
      .message.user .text {
        background: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .message.user .timestamp {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 4px;
      }

      .input-area {
        padding: 20px;
        background: white;
        border-top: 2px solid #e5e7eb;
        display: flex;
        gap: 12px;
      }
      .input-area input {
        flex: 1;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        font-size: 16px;
      }
      .input-area input:focus {
        outline: none;
        border-color: #667eea;
      }
      .input-area button {
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .input-area button:hover {
        transform: translateY(-2px);
      }
      .input-area button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .error {
        background: #fee2e2;
        color: #991b1b;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 12px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üí¨ Chat WebSocket</h1>
        <div class="status" id="status">D√©connect√©</div>
      </div>

      <div class="login-form" id="loginForm">
        <div class="error" id="error" style="display: none"></div>
        <input
          type="text"
          id="usernameInput"
          placeholder="Votre pseudo"
          maxlength="20"
          autofocus
        />
        <input
          type="text"
          id="tokenInput"
          placeholder="Token (SECRET_TOKEN_123)"
          value="SECRET_TOKEN_123"
        />
        <button id="connectBtn">Se connecter</button>
      </div>

      <div class="chat-container" id="chatContainer">
        <div class="messages" id="messages"></div>
        <div class="input-area">
          <input
            type="text"
            id="messageInput"
            placeholder="Votre message..."
            maxlength="500"
          />
          <button id="sendBtn">Envoyer</button>
        </div>
      </div>
    </div>

    <script>
      const WS_URL = "ws://localhost:8080/ws";

      let ws = null;
      let username = "";
      let reconnectAttempts = 0;
      const MAX_RECONNECT_ATTEMPTS = 5;

      // √âl√©ments DOM
      const loginForm = document.getElementById("loginForm");
      const chatContainer = document.getElementById("chatContainer");
      const usernameInput = document.getElementById("usernameInput");
      const tokenInput = document.getElementById("tokenInput");
      const connectBtn = document.getElementById("connectBtn");
      const messagesDiv = document.getElementById("messages");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const statusDiv = document.getElementById("status");
      const errorDiv = document.getElementById("error");

      // Connexion WebSocket
      function connect() {
        username = usernameInput.value.trim();
        const token = tokenInput.value.trim();

        if (!username) {
          showError("Veuillez entrer un pseudo");
          return;
        }

        if (!token) {
          showError("Veuillez entrer un token");
          return;
        }

        hideError();
        updateStatus("connecting", "Connexion en cours...");
        connectBtn.disabled = true;

        // Connexion avec token en query parameter
        ws = new WebSocket(`${WS_URL}?token=${encodeURIComponent(token)}`);

        ws.onopen = () => {
          console.log("‚úÖ WebSocket connected");
          updateStatus("connected", `Connect√© en tant que ${username}`);
          reconnectAttempts = 0;

          // Afficher le chat
          loginForm.style.display = "none";
          chatContainer.classList.add("active");
          messageInput.focus();
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            handleMessage(data);
          } catch (error) {
            console.error("Error parsing message:", error);
          }
        };

        ws.onerror = (error) => {
          console.error("‚ùå WebSocket error:", error);
        };

        ws.onclose = (event) => {
          console.log("WebSocket closed:", event.code, event.reason);
          updateStatus("disconnected", "D√©connect√©");

          // Si erreur auth (code 1008), afficher erreur
          if (event.code === 1008) {
            showError("Authentification √©chou√©e : token invalide");
            chatContainer.classList.remove("active");
            loginForm.style.display = "block";
            connectBtn.disabled = false;
            return;
          }

          // Tentative de reconnexion
          if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
            reconnectAttempts++;
            const delay = Math.min(
              1000 * Math.pow(2, reconnectAttempts),
              10000
            );
            updateStatus("connecting", `Reconnexion dans ${delay / 1000}s...`);
            setTimeout(connect, delay);
          } else {
            showError("Impossible de se reconnecter. Rechargez la page.");
            chatContainer.classList.remove("active");
            loginForm.style.display = "block";
            connectBtn.disabled = false;
          }
        };
      }

      // Envoi message
      function sendMessage() {
        const text = messageInput.value.trim();

        if (!text) return;
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          showError("Non connect√© au serveur");
          return;
        }

        ws.send(
          JSON.stringify({
            type: "message",
            username: username,
            text: text,
          })
        );

        messageInput.value = "";
        messageInput.focus();
      }

      // Gestion des messages re√ßus
      function handleMessage(data) {
        switch (data.type) {
          case "message":
            addUserMessage(data.username, data.text, data.timestamp);
            break;
          case "user_joined":
            addSystemMessage(`${data.username} a rejoint le chat`);
            break;
          case "user_left":
            addSystemMessage(`${data.username} a quitt√© le chat`);
            break;
          default:
            console.log("Unknown message type:", data.type);
        }
      }

      // Affichage messages
      function addUserMessage(username, text, timestamp) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message user";

        const time = new Date(timestamp).toLocaleTimeString("fr-FR", {
          hour: "2-digit",
          minute: "2-digit",
        });

        messageDiv.innerHTML = `
                <div class="username">${escapeHtml(username)}</div>
                <div class="text">${escapeHtml(text)}</div>
                <div class="timestamp">${time}</div>
            `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function addSystemMessage(text) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message system";
        messageDiv.textContent = text;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // Utilitaires
      function updateStatus(state, text) {
        statusDiv.className = `status ${state}`;
        statusDiv.textContent = text;
      }

      function showError(message) {
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      }

      function hideError() {
        errorDiv.style.display = "none";
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Event listeners
      connectBtn.addEventListener("click", connect);

      usernameInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") connect();
      });

      tokenInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") connect();
      });

      sendBtn.addEventListener("click", sendMessage);

      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      // Gestion d√©connexion
      window.addEventListener("beforeunload", () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.close();
        }
      });
    </script>
  </body>
</html>
